#include "font.h"
#include <ctype.h>

/* ── Glyph data ───────────────────────────────────────────────────
   64 entries, indexed by (char - 0x20).  Range: 0x20 ' ' … 0x5F '_'.
   Each glyph = 7 bytes, one per row (top to bottom).
   Bit layout per row byte: bit 4 = leftmost pixel (col 0),
                             bit 0 = rightmost pixel (col 4).
   Undefined / rarely-used chars use a simple placeholder glyph.   */
static const uint8_t FONT[64][FONT_H] = {
/*0x20 ' '*/ {0x00,0x00,0x00,0x00,0x00,0x00,0x00},
/*0x21 '!'*/ {0x04,0x04,0x04,0x04,0x04,0x00,0x04},
/*0x22 '"'*/ {0x0A,0x0A,0x00,0x00,0x00,0x00,0x00},
/*0x23 '#'*/ {0x0A,0x1F,0x0A,0x0A,0x1F,0x0A,0x00},
/*0x24 '$'*/ {0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04},
/*0x25 '%'*/ {0x11,0x02,0x04,0x04,0x08,0x11,0x00},
/*0x26 '&'*/ {0x0C,0x12,0x14,0x08,0x15,0x12,0x0D},
/*0x27 '\''*/{0x04,0x08,0x00,0x00,0x00,0x00,0x00},
/*0x28 '('*/ {0x02,0x04,0x08,0x08,0x08,0x04,0x02},
/*0x29 ')'*/ {0x08,0x04,0x02,0x02,0x02,0x04,0x08},
/*0x2A '*'*/ {0x00,0x11,0x0A,0x1F,0x0A,0x11,0x00},
/*0x2B '+'*/ {0x00,0x04,0x04,0x1F,0x04,0x04,0x00},
/*0x2C ','*/ {0x00,0x00,0x00,0x00,0x06,0x06,0x0C},
/*0x2D '-'*/ {0x00,0x00,0x00,0x1F,0x00,0x00,0x00},
/*0x2E '.'*/ {0x00,0x00,0x00,0x00,0x00,0x06,0x06},
/*0x2F '/'*/ {0x01,0x02,0x02,0x04,0x08,0x08,0x10},
/*0x30 '0'*/ {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E},
/*0x31 '1'*/ {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E},
/*0x32 '2'*/ {0x0E,0x11,0x01,0x06,0x08,0x10,0x1F},
/*0x33 '3'*/ {0x1E,0x01,0x01,0x0E,0x01,0x01,0x1E},
/*0x34 '4'*/ {0x02,0x06,0x0A,0x12,0x1F,0x02,0x02},
/*0x35 '5'*/ {0x1F,0x10,0x10,0x1E,0x01,0x01,0x1E},
/*0x36 '6'*/ {0x0E,0x10,0x10,0x1E,0x11,0x11,0x0E},
/*0x37 '7'*/ {0x1F,0x01,0x02,0x04,0x04,0x04,0x04},
/*0x38 '8'*/ {0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E},
/*0x39 '9'*/ {0x0E,0x11,0x11,0x0F,0x01,0x01,0x0E},
/*0x3A ':'*/ {0x00,0x06,0x06,0x00,0x06,0x06,0x00},
/*0x3B ';'*/ {0x00,0x06,0x06,0x00,0x06,0x06,0x0C},
/*0x3C '<'*/ {0x02,0x04,0x08,0x10,0x08,0x04,0x02},
/*0x3D '='*/ {0x00,0x00,0x1F,0x00,0x1F,0x00,0x00},
/*0x3E '>'*/ {0x08,0x04,0x02,0x01,0x02,0x04,0x08},
/*0x3F '?'*/ {0x0E,0x11,0x01,0x06,0x04,0x00,0x04},
/*0x40 '@'*/ {0x0E,0x11,0x17,0x15,0x16,0x10,0x0E},
/*0x41 'A'*/ {0x0E,0x11,0x11,0x1F,0x11,0x11,0x11},
/*0x42 'B'*/ {0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E},
/*0x43 'C'*/ {0x0E,0x11,0x10,0x10,0x10,0x11,0x0E},
/*0x44 'D'*/ {0x1C,0x12,0x11,0x11,0x11,0x12,0x1C},
/*0x45 'E'*/ {0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F},
/*0x46 'F'*/ {0x1F,0x10,0x10,0x1E,0x10,0x10,0x10},
/*0x47 'G'*/ {0x0E,0x11,0x10,0x10,0x13,0x11,0x0E},
/*0x48 'H'*/ {0x11,0x11,0x11,0x1F,0x11,0x11,0x11},
/*0x49 'I'*/ {0x1F,0x04,0x04,0x04,0x04,0x04,0x1F},
/*0x4A 'J'*/ {0x1F,0x02,0x02,0x02,0x02,0x12,0x0C},
/*0x4B 'K'*/ {0x11,0x12,0x14,0x18,0x14,0x12,0x11},
/*0x4C 'L'*/ {0x10,0x10,0x10,0x10,0x10,0x10,0x1F},
/*0x4D 'M'*/ {0x11,0x1B,0x15,0x15,0x11,0x11,0x11},
/*0x4E 'N'*/ {0x11,0x19,0x15,0x13,0x11,0x11,0x11},
/*0x4F 'O'*/ {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E},
/*0x50 'P'*/ {0x1E,0x11,0x11,0x1E,0x10,0x10,0x10},
/*0x51 'Q'*/ {0x0E,0x11,0x11,0x11,0x15,0x12,0x0D},
/*0x52 'R'*/ {0x1E,0x11,0x11,0x1E,0x14,0x12,0x11},
/*0x53 'S'*/ {0x0F,0x10,0x10,0x0E,0x01,0x01,0x1E},
/*0x54 'T'*/ {0x1F,0x04,0x04,0x04,0x04,0x04,0x04},
/*0x55 'U'*/ {0x11,0x11,0x11,0x11,0x11,0x11,0x0E},
/*0x56 'V'*/ {0x11,0x11,0x11,0x11,0x0A,0x0A,0x04},
/*0x57 'W'*/ {0x11,0x11,0x15,0x15,0x15,0x1B,0x11},
/*0x58 'X'*/ {0x11,0x11,0x0A,0x04,0x0A,0x11,0x11},
/*0x59 'Y'*/ {0x11,0x11,0x0A,0x04,0x04,0x04,0x04},
/*0x5A 'Z'*/ {0x1F,0x01,0x02,0x04,0x08,0x10,0x1F},
/*0x5B '['*/ {0x0E,0x08,0x08,0x08,0x08,0x08,0x0E},
/*0x5C '\'*/ {0x10,0x08,0x08,0x04,0x02,0x02,0x01},
/*0x5D ']'*/ {0x0E,0x02,0x02,0x02,0x02,0x02,0x0E},
/*0x5E '^'*/ {0x04,0x0A,0x11,0x00,0x00,0x00,0x00},
/*0x5F '_'*/ {0x00,0x00,0x00,0x00,0x00,0x00,0x1F},
};

int font_char_w(void) { return (FONT_W + 1) * FONT_SCALE; }
int font_line_h(void) { return (FONT_H + 2) * FONT_SCALE; }

void font_draw_char(SDL_Renderer *ren, char c, int x, int y, SDL_Color col) {
    /* Map lowercase → uppercase; clamp everything else to range. */
    if (c >= 'a' && c <= 'z') c = (char)(c - 'a' + 'A');
    if (c < 0x20 || c > 0x5F) c = '?';

    const uint8_t *g = FONT[(uint8_t)c - 0x20];
    SDL_SetRenderDrawColor(ren, col.r, col.g, col.b, col.a);

    for (int row = 0; row < FONT_H; row++) {
        for (int px = 0; px < FONT_W; px++) {
            if (g[row] & (0x10 >> px)) {
                SDL_Rect r = {
                    x + px * FONT_SCALE,
                    y + row * FONT_SCALE,
                    FONT_SCALE, FONT_SCALE
                };
                SDL_RenderFillRect(ren, &r);
            }
        }
    }
}

void font_draw_str(SDL_Renderer *ren, const char *s, int x, int y, SDL_Color col) {
    int cx = x;
    for (; *s; s++) {
        if (*s == '\n') {
            cx  = x;
            y  += font_line_h();
        } else {
            font_draw_char(ren, *s, cx, y, col);
            cx += font_char_w();
        }
    }
}
